const express = require("express");
const session = require("express-session");
const path = require("path");

const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(session({ secret: "sunwin-secret", resave: false, saveUninitialized: true }));
app.use(express.static("public"));

// Dữ liệu demo
let users = [];
let adminUser = { username: "admin", password: "123456" };

// Trang chủ
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

// API đăng ký
app.post("/api/register", (req, res) => {
  const { username, password } = req.body;
  if (users.find(u => u.username === username)) {
    return res.status(400).json({ error: "User tồn tại" });
  }
  users.push({ id: Date.now(), username, password, balance: 0 });
  res.json({ success: true });
});

// API đăng nhập user
app.post("/api/login", (req, res) => {
  const { username, password } = req.body;
  const user = users.find(u => u.username === username && u.password === password);
  if (!user) return res.status(400).json({ error: "Sai thông tin" });
  req.session.user = user;
  res.json({ success: true });
});

// API nạp tiền
app.post("/api/deposit", (req, res) => {
  if (!req.session.user) return res.status(401).json({ error: "Chưa đăng nhập" });
  const { amount } = req.body;
  req.session.user.balance += Number(amount);
  res.json({ success: true, balance: req.session.user.balance });
});

// API rút tiền
app.post("/api/withdraw", (req, res) => {
  if (!req.session.user) return res.status(401).json({ error: "Chưa đăng nhập" });
  const { amount } = req.body;
  if (req.session.user.balance < amount) return res.status(400).json({ error: "Không đủ tiền" });
  req.session.user.balance -= Number(amount);
  res.json({ success: true, balance: req.session.user.balance });
});

// Trang đăng nhập admin
app.get("/admin-login", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "admin-login.html"));
});

// API admin login
app.post("/api/admin-login", (req, res) => {
  const { username, password } = req.body;
  if (username === adminUser.username && password === adminUser.password) {
    req.session.admin = true;
    return res.json({ success: true });
  }
  res.status(400).json({ error: "Sai tài khoản admin" });
});

// Trang admin
app.get("/admin.html", (req, res) => {
  if (!req.session.admin) return res.redirect("/admin-login");
  res.sendFile(path.join(__dirname, "public", "admin.html"));
});

// API lấy danh sách user
app.get("/api/users", (req, res) => {
  if (!req.session.admin) return res.status(401).json({ error: "Không có quyền" });
  res.json(users);
});

// API xóa user
app.delete("/api/users/:id", (req, res) => {
  if (!req.session.admin) return res.status(401).json({ error: "Không có quyền" });
  const { id } = req.params;
  users = users.filter(u => u.id != id);
  res.json({ success: true });
});

app.listen(PORT, () => console.log(`Server chạy tại http://localhost:${PORT}`));
